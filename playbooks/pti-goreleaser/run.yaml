---
- hosts: all
  vars:
    vault_token_dest: "{{ ansible_user_dir }}/.approle-token"
  tasks:
    - name: Fetch gpg key from vault
      delegate_to: localhost
      # no_log: true
      vault_read:
        vault_addr: "{{ vault_addr }}"
        vault_token: "{{ lookup('file', vault_token_dest) }}"
        secret_path: "{{ secret_path_gpg }}"
      register: gpg_secret

    - name: Fetch GitHub token
      vars:
        project: "{{ zuul.project.name | split('/') }}"
      delegate_to: localhost
      uri:
        url: "{{ vault_addr }}/v1/{{ vault_github_token_path }}"
        headers:
          "X-Vault-Token": "{{ lookup('file', vault_token_dest) }}"
        method: "POST"
        data:
          permissions: "contents=write"
          org_name: "{{ project[0] }}"
          repositories: "{{ project[1] }}"
      register: github_token

    - name: Create GPG private key tempfile
      tempfile:
        state: file
      register: gpg_private_key_tmp

    - name: Create GPG private key
      copy:
        content: "{{ gpg_secret.secret.private_key }}"
        dest: "{{ gpg_private_key_tmp.path }}"
        mode: 0400

    - name: Import GPG private key
      command: "gpg --allow-secret-key-import --import {{ gpg_private_key_tmp.path }}"

    - name: Delete GPG private key
      file:
        path: "{{ gpg_private_key_tmp.path }}"
        state: absent

    - name: Trigger goreleaser
      command: "bin/goreleaser release"
      args:
        chdir: "{{ zuul.project.src_dir }}"
      environment:
        GITHUB_TOKEN: "{{ github_token.data.token | default('fake') }}"
        PATH: "/usr/local/go/bin:{{ ansible_env.PATH }}"

    - name: Revoke GitHub token
      delegate_to: localhost
      uri:
        url: "{{ vault_addr }}/v1/sys/leases/revoke"
        headers:
          "X-Vault-Token": "{{ lookup('file', vault_token_dest) }}"
        method: "DELETE"
        data:
          lease_id: "{{ github_token.lease_id }}"

    - name: Unset vault_token
      set_fact:
        vault_token: ''
