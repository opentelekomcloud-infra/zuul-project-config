- hosts: localhost
  vars:
    vault_addr: "{{ zuul_vault_addr }}"
    vault_token: "{{ lookup('file', zuul_base_vault_token_path) }}"
    vault_secret_dest: "{{ ansible_user_dir }}/.approle-secret"
    vault_token_dest: "{{ ansible_user_dir }}/.approle-token"

    vault_role_name: "{{ vault_data.vault_role_name }}"

  roles:
    - role: create-vault-approle-secret
      when: zuul_success | bool

    - role: create-vault-approle-token
      vault_role_id: "{{ vault_data.vault_role_id }}"
      vault_wrapping_token_id: "{{ lookup('file', vault_secret_dest) }}"
      when: zuul_success | bool

  tasks:
    - block:

        - name: Find PDF files
          find:
            paths: "{{ zuul.executor.work_root }}/"
            file_type: file
            patterns: "*.pdf"
          register: pdf_files

        # If we have PDF we want to add it into the artifacts archive and upload at once
        # For this unpack>add>archive
        - name: Create working directory
          file:
            path: "{{ zuul.executor.work_root }}/docs"
            state: directory
            mode: 0755
          when: pdf_files.matched > 0

        - name: Extract docs archive
          vars:
            findme:
              - "{{ zuul.executor.work_root }}/docs-html.tar.bz2"
              - "{{ zuul.executor.work_root }}/docs-html.tar.gz"
          unarchive:  # noqa 208
            src: "{{ lookup('first_found', findme) }}"
            dest: "{{ zuul.executor.work_root }}/docs"
          when: pdf_files.matched > 0

        - name: Move found PDF file into doc dir
          command: "mv {{ item.path }} {{ zuul.executor.work_root }}/docs"
          with_items: "{{ pdf_files.files }}"
          when: pdf_files.matched > 0

        - name: Archive Docs - now with PDF inside
          command: "tar -f docs-html.tar.gz -C {{ zuul.executor.work_root }}/docs --exclude=.doctrees -cz ."
          args:
            warn: false
          when: pdf_files.matched > 0

        - name: Get cloud config from vault
          no_log: true
          vault_cloud_config:
            vault_addr: "{{ vault_addr }}"
            vault_token: "{{ lookup('file', vault_token_dest) }}"
            cloud_secret_path: "{{ promote_data.vault_cloud_secret_path }}"
            mode: "token"
          register: cloud_config

        - name: Upload docs
          include_role:
            name: upload-artifact-swift
          vars:
            artifact_src: "{{ zuul.executor.work_root }}/docs-html.tar.gz"
            upload_artifact_swift_cloud: "{{ cloud_config.config }}"
            upload_artifact_swift_container_name: "{{ container | default(zuul.project.short_name) }}"
            upload_artifact_swift_prefix: "{{ prefix | default(omit) }}"
            upload_artifact_swift_container_public: "{{ make_public | default(omit) }}"

        - name: Destroy vault token
          include_role:
            name: destroy-vault-token
          vars:
            vault_token: "{{ lookup('file', vault_token_dest) }}"

        - name: Remove vault token file
          file:
            path: "{{ vault_token_dest }}"
            state: "absent"
      when: zuul_success | bool
